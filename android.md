# Основные архитектурные особенности Android

Android является операционной системой, базирующейся на модифицированном ядре Linux.

В Android используется концепция **колец защиты**, также известная как **privilege levels**, или **rings**. Эта концепция является частью модели безопасности Linux. 

Более подробную информацию следует искать по ключевому слову [SELinux](https://ru.wikipedia.org/wiki/SELinux). 

Акроним SELinux расшифровывается как **Security-Enhanced Linux**, т.е. Linux с улучшенной безопасностью. Краткая [информация о SELinux](https://serverspace.ru/support/glossary/selinux/?utm_source=google.com&utm_medium=organic&utm_campaign=google.com&utm_referrer=google.com). Рекомендуется для ознакомления статья [Руководство для начинающих по SELinux](https://habr.com/ru/companies/otus/articles/460387/) by SHUSAIN.

Основные кольца защиты в Android:

- Ring 0: ядро операционной системы работает в Кольце 0, также известном, как kernel mode. Это наиболее привилигированный уровень, который имеет полный доступ к аппаратным ресурсам
- Ring 3: приложения Android (включая приложения разработанные на Java, или Kotlin) работают в Кольце 3, также известном как **user mode**. Это наименее привилигированный уровень, на котором приложения имеют ограниченный доступ к аппаратным ресурсам (через ядро) и изолированы (sandboxed) друг от друга.

Цель **ring-based model** - предотвратить доступ кода злоумышленников к "чувствительным" данным в системе.

Получить доступ к аппаратным ресурсам из приложений Android можно в следующих случаях:

- Используется rooted-устройство, т.е. установлен root-level доступ для приложения/всех приложений. Другими словами, если модель безопасности полностью сломана
- Через системные сервисы, которые предоставляют API для работы с устройствами

Т.е. для доступа к аппаратному обеспечению на не взломанном устройстве необходимо:

- либо разработать драйвера устройства и встроить его в Android
- либо использовать системные сервисы, или API

С каждым приложением связан манифест (файл "AndroidManifest.xml" в проекте сборки приложения), который содержит мета-данные:

- список компонентов приложения: Activities, сервисы, получатели широковещательный событий и поставщики контента
- список разрешений, которые нужны приложению, например: доступ к камере, или доступ к данным о местоположении устройства
- определяет intents и intent filters - способы, которыми другие приложения могут использовать activities данного приложения
- имя приложения, иконки и версию приложения
- также хранит особенности поведения приложения: поддерживаемые ориентации экрана, темы, API level 

Операционная система использует манифест приложения для:

- управления жизненным циклом: понимает, какие компоненты используются в приложении, а также то, как можно использовать эти компоненты
- предоставляет доступ только к заявленным в манифесте разрешениями и выполняет соответствующие действия
- использует для вывода иконки на главный экран. Также использует для извлечения информации о приложении в Google Play

Указания разрешений в манифесте не достаточно для того, чтобы получить доступ к соответствующим сервисами. Перед тем, как сервис будет использован в первый раз, приложение должно вызывать функцию `requestPermissions()`, которая запросит у пользователя подтверждение разрешения приложению выполнять запрашиваемые действия.

Начиная с API level 23, Android разделяет все разрешения на две категории:

- **Обычные разрешения** - их не нужно подтверждать пользователю при первом запуске приложения. Достаточно подтвердить их при установке приложения. К таким разрешениям относятся: доступ в интернет, доступ к информации о состоянии Wi-Fi адаптера, доступ к системной информации (на чтение)
- **Опасные разрешения** - они обязательно должны быть подтверждены пользователем перед первым доступе приложения к сервису

В Android есть принципиальное отличие между драйверами, системными сервисами и фоновыми сервисами:

- драйвер, является частью операционной системы и работает в kernel mode
- системные сервисы (**System-Level Services**) встроены в Android и выполняются в процессе `system_server`. Эти сервисы реализуют такие функции, как: Window Manager, Activity Manager, Package Manager и Power Manager. Система не останавливает эти сервисы, она работают, пока работает операционная система
- фоновые сервисы (**Foreground Services**, или **Background Services**) запускаются в том же процессе, что и обычные приложений (user mode). Они запускаются и останавливаются посредством API (см. startService(), stopService()). Фоновые сервисы так же могут запросить подтверждение разрешения (см. метод `bindService()`) для доступа к ресурсам операционной системы, как и обычное приложение. Операционная система может остановить такой сервис, если её потребуется освободить ресурсы
